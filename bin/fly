#!/bin/bash

set -e

if [ "$1" == "show" ]; then
  if [ "$2" != "" ]; then
    cat $2
  fi
  exit 0
fi

echo "Fly Container Package Manager"
echo "Version $FLY_VERSION"
echo "----------------------------------------------------------------"
echo "Package:"
echo "  Group:                $GROUP"
echo "  Application:          $APPLICATION"
echo "  Version:              $VERSION"
echo "  Revision:             $REVISION"
echo "  Description:          $DESCRIPTION"
echo "  Company:              $COMPANY"
echo "  Web:                  $WEB"
echo "  Repository:           $REPOSITORY"
echo "  Branch:               $BRANCH"
echo "  Commit:               $COMMIT"
echo "  Commit Time:          $COMMIT_TIME"
echo "  Commit Author:        $COMMIT_AUTHOR"
echo "  Commit Author Email:  $COMMIT_AUTHOR_EMAIL"
echo "  Build:                $BUILD"
echo "  Build Time:           $BUILD_TIME"
echo "----------------------------------------------------------------"
echo "Config:"
for CONF in /conf/*; do
  echo "  - $CONF";
done
echo "----------------------------------------------------------------"
echo "Stage:"
cd /act
for STAGE in *; do
  echo "  * $STAGE";
  if [ "$STAGE" != "*" ]; then
    echo "      Action:"
    cd /act/$STAGE
    for ACT in *; do
      echo "        $ACT"
    done
    echo "      Parameters:"
    for PARAM in /param/$STAGE/*; do
      echo "        - $PARAM";
    done
  fi
done
cd /pack
echo "----------------------------------------------------------------"

if [ "$1" == "fly" ]; then
  if [ "$2" != "all" ]; then
    echo "fly:"
    echo "  Stage: $2"
    echo "  Action: $3"
    echo "  Arguments: ${@:4}"
    echo ""
    cd /pack/$2
    /act/$2/$3 ${@:4}
    echo "----------------------------------------------------------------"
  else
    cd /act
    for STAGE in *; do
      echo "fly:"
      echo "  Stage: $STAGE"
      echo "  Action: $3"
      echo "  Arguments: ${@:4}"
      echo ""
      cd /pack/$STAGE
      /act/$STAGE/$3 ${@:4}
      echo "----------------------------------------------------------------"
    done
    cd /pack
  fi
elif [ "$1" == "shell" ]; then
  echo "shell:"
  /bin/bash ${@:2}
else
  echo "help:"
  echo "  Command:"
  echo "    fly   - run an action on the specified/all stage(s):"
  echo "            docker run -it -v conf:/conf -v param:/param IMAGE fly STAGE ACTION [ARGUMENTS]"
  echo "            docker run -it -v conf:/conf -v param:/param IMAGE fly all ACTION [ARGUMENTS]"
  echo ""
  echo "    show  - output the contents of the specified file:"
  echo "            docker run -it IMAGE show FILE"
  echo ""
  echo "    shell - enter an interactive shell:"
  echo "            docker run -it IMAGE bash [ARGUMENTS]"
  echo ""
  echo "    help  - get this help:"
  echo "            docker run -it IMAGE help"
  if [ $# -eq 0 ] || [ "$1" == "help" ]; then
    echo ""
  else
    echo ""
    echo "Unknown command: $1"
    echo ""
  fi
fi
